@import "tailwindcss";
@import "@fontsource-variable/jetbrains-mono";

@theme {
  --color-primary: var(--primary);
  --color-secondary: var(--secondary);
  --color-accent: var(--accent);
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-success: var(--success);
  --color-error: var(--error);
  --color-warning: var(--warning);
  --color-info: var(--info);
  
  --breakpoint-xs: 30rem;
  --breakpoint-menu: 35rem;
  --breakpoint-lg: 56.25rem;
  
  /* Extra small text sizes for UI components */
  --text-2xs: calc(var(--text-xs) * 0.833);
  --text-3xs: calc(var(--text-xs) * 0.7);
}

:root {
  --bg-color: #ffffff; /* Fallback */
}

html {
  background-color: var(--background);
  color: var(--secondary);
}

body {
  background-color: transparent;
  color: inherit;
  font-family: var(--font-mono);
  line-height: var(--line-spacing);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Mobile zoom adjustment for better fit on small screens */
@media (width < 30rem) {
  html {
    font-size: 16px; /* Reduce base font size from default 16px */
  }
}

/* Scrollbar styling */
/* Chrome, Edge, Safari */
::-webkit-scrollbar {
  width: 5px;
  height: 5px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: var(--foreground);
  border-radius: var(--radius-lg);
}
::-webkit-scrollbar-thumb:hover {
  background: var(--primary);
}

/* Firefox only - apply standard scrollbar properties */
@supports not selector(::-webkit-scrollbar) {
  * {
    scrollbar-width: thin;
    scrollbar-color: var(--primary) transparent;
  }
}

/* Override browser autofill styling to match theme */
input:-webkit-autofill,
input:-webkit-autofill:hover,
input:-webkit-autofill:focus,
input:-webkit-autofill:active,
textarea:-webkit-autofill,
textarea:-webkit-autofill:hover,
textarea:-webkit-autofill:focus,
textarea:-webkit-autofill:active,
select:-webkit-autofill,
select:-webkit-autofill:hover,
select:-webkit-autofill:focus,
select:-webkit-autofill:active {
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: var(--secondary) !important;
  background-color: var(--background) !important;
  box-shadow: 0 0 0 1000px var(--background) inset !important;
  caret-color: var(--secondary) !important;
}

/* Utilities */
.btn-toolbar {
  @apply h-9 px-3 rounded-[var(--radius-sm)] text-sm font-semibold bg-transparent border-2 border-primary text-primary hover:bg-foreground transition-colors cursor-pointer;
}

.btn-icon {
  @apply p-2 rounded-[var(--radius-sm)] text-secondary hover:bg-foreground transition-colors cursor-pointer;
}

/* Sidebar Container Query Logic */
/* 
 * When cell is short (toolbar doesn't fit), force center alignment.
 * Uses CSS variables that transition smoothly.
 * The JS sets base alignment, container query overrides to center when short.
 */
@container cell-sidebar (max-height: 125px) {
  .sidebar-inner-auto-center {
    --sidebar-top: 50% !important;
    --sidebar-transform: translateY(-50%) !important;
  }
}

/* Milkdown & Prose Overrides */
.milkdown-editor-wrapper {
  @apply min-h-12.5;
}
.milkdown .editor {
  @apply bg-transparent text-secondary font-mono outline-none ring-0 border-none;
  caret-color: var(--accent);
}
.milkdown .editor:focus {
  @apply outline-none ring-0 border-none;
}

/* Fix Tailwind resets for Milkdown content and Prose (Shared styles) */
.milkdown .editor ul,
.prose ul {
    list-style-type: disc !important;
    padding-left: 1.5rem !important;
    margin-top: var(--block-margin) !important;
    margin-bottom: var(--block-margin) !important;
    margin-left: 1.5rem !important;
}
.milkdown .editor ol,
.prose ol {
    list-style-type: decimal !important;
    /* Reverting left padding/margin alignment as requested */
    padding-left: 1.5rem !important; 
    margin-top: var(--block-margin) !important;
    margin-bottom: var(--block-margin) !important;
    margin-left: 2.2rem !important;
}
.milkdown .editor li::marker,
.prose li::marker {
    color: var(--primary);
    font-weight: bold;
}

/* Remove left margin for nested lists */
.milkdown .editor li > ul,
.milkdown .editor li > ol,
.prose li > ul,
.prose li > ol {
    margin-left: 0.5rem !important;
}

/* Table wrapper with border and overflow scrolling */
.milkdown .editor .table-wrapper,
.prose .table-wrapper {
    display: block;
    overflow-x: auto;
    border: 2px solid color-mix(in srgb, var(--secondary) 40%, transparent);
    border-radius: var(--radius-sm);
    margin-top: var(--block-margin) !important;
    margin-bottom: var(--block-margin) !important;
    margin-right: 5px;
}

/* Table inside wrapper stretches to fit or overflow */
.milkdown .editor .table-wrapper table,
.prose .table-wrapper table {
    width: max-content;
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0 !important;
}

/* Wrap mode overrides using CSS variable */
:root:has([style*="--table-overflow: wrap"]) .prose .table-wrapper {
    overflow-x: visible;
}

:root:has([style*="--table-overflow: wrap"]) .prose .table-wrapper table {
    width: 100%;
    table-layout: fixed;
}

:root:has([style*="--table-overflow: wrap"]) .prose .table-wrapper table th,
:root:has([style*="--table-overflow: wrap"]) .prose .table-wrapper table td {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* For Milkdown editor tables without wrapper, apply styles directly */
.milkdown .editor table:not(.table-wrapper table) {
    display: block;
    overflow-x: auto;
    width: 100%;
    border: 2px solid color-mix(in srgb, var(--secondary) 40%, transparent);
    border-radius: var(--radius-sm);
    margin-top: var(--block-margin) !important;
    margin-bottom: var(--block-margin) !important;
}

.milkdown .editor table:not(.table-wrapper table) > * {
    display: table;
    width: max-content;
    min-width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

/* Milkdown wrap mode overrides using CSS variable */
:root:has([style*="--table-overflow: wrap"]) .milkdown .editor table:not(.table-wrapper table) {
    display: table;
    overflow-x: visible;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 0;
}

:root:has([style*="--table-overflow: wrap"]) .milkdown .editor table th,
:root:has([style*="--table-overflow: wrap"]) .milkdown .editor table td {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.milkdown .editor th,
.milkdown .editor td,
.prose th,
.prose td {
    padding: 0.6rem 0.8rem;
    text-align: left;
    position: relative;
}

/* Header Styles */
.milkdown .editor th,
.prose th {
    background-color: color-mix(in srgb, var(--accent) 10%, transparent);
    font-weight: 600;
    color: var(--secondary);
    border-bottom: 2px solid color-mix(in srgb, var(--accent) 10%, transparent);
    border-right: 2px solid color-mix(in srgb, var(--accent) 10%, transparent);
}

/* Body Cell Styles */
.milkdown .editor td,
.prose td {
    border-bottom: 2px solid color-mix(in srgb, var(--accent) 10%, transparent);
    border-right: 2px solid color-mix(in srgb, var(--accent) 10%, transparent);
}

/* Remove outer borders from cells to respect table radius */
.milkdown .editor th:last-child,
.milkdown .editor td:last-child,
.prose th:last-child,
.prose td:last-child {
    border-right: none;
}

.milkdown .editor tr:last-child td,
.prose tr:last-child td {
    border-bottom: none;
}

.milkdown .editor code {
    font-family: var(--code-font-family);
    font-size: var(--code-inline-font-size);
    font-weight: var(--code-font-weight);
    background-color: color-mix(in srgb, var(--foreground) 20%, transparent);
    padding: 0.2em 0.4em;
    border-radius: var(--radius-sm);
}

/* Markdown cell placeholder text */
.markdown-placeholder {
    color: var(--foreground);
}

/* Fix Tailwind resets for Prose (Presentation Mode) - Removed duplicates, now shared above */
.prose code {
    font-family: var(--code-font-family) !important;
    font-size: var(--code-inline-font-size) !important;
    font-weight: var(--code-font-weight) !important;
    background-color: color-mix(in srgb, var(--accent) 8%, transparent);
    padding: 0.2em 0.5em;
    border-radius: var(--radius-sm);
    color: color-mix(in srgb, var(--secondary) 75%, transparent) !important;
}

/* Code blocks (pre > code) - distinct block styling */
.prose pre,
.milkdown .editor pre {
    background-color: color-mix(in srgb, var(--accent) 5%, transparent) !important;
    border: 2px solid color-mix(in srgb, var(--secondary) 40%, transparent);
    border-radius: var(--radius-sm);
    padding: 1em !important;
    margin-top: var(--block-margin) !important;
    margin-bottom: var(--block-margin) !important;
    overflow-x: auto;
}
/* Reduce margins when pre is at edges of container */
.prose pre:first-child,
.milkdown .editor pre:first-child {
    margin-top: 0.5rem !important;
}
.prose pre:last-child,
.milkdown .editor pre:last-child {
    margin-bottom: 0.5rem !important;
}
.prose pre code,
.milkdown .editor pre code {
    background-color: transparent !important;
    padding: 0 !important;
    border-radius: 0 !important;
    font-family: var(--code-font-family) !important;
    font-size: var(--code-base-font-size) !important;
    font-weight: var(--code-font-weight) !important;
    color: color-mix(in srgb, var(--secondary) 75%, transparent) !important;
}

/* highlight.js theme - Duotone Dark matching CodeMirror */
.prose pre code .hljs-keyword,
.prose pre code .hljs-selector-tag,
.prose pre code .hljs-literal,
.prose pre code .hljs-section,
.prose pre code .hljs-link {
    color: #ffcc99 !important;
}
.prose pre code .hljs-function .hljs-keyword {
    color: #ffcc99 !important;
}
.prose pre code .hljs-string,
.prose pre code .hljs-attr {
    color: #ffb870 !important;
}
.prose pre code .hljs-number,
.prose pre code .hljs-regexp,
.prose pre code .hljs-type,
.prose pre code .hljs-built_in,
.prose pre code .hljs-builtin-name {
    color: #ffcc99 !important;
}
.prose pre code .hljs-title,
.prose pre code .hljs-name,
.prose pre code .hljs-variable,
.prose pre code .hljs-params {
    color: #eeebff !important;
}
.prose pre code .hljs-comment,
.prose pre code .hljs-quote {
    color: #6c6783 !important;
    font-style: italic;
}
.prose pre code .hljs-meta,
.prose pre code .hljs-tag {
    color: #6c6783 !important;
}
.prose pre code .hljs-attribute,
.prose pre code .hljs-property {
    color: #9a86fd !important;
}
.prose pre code .hljs-symbol,
.prose pre code .hljs-bullet,
.prose pre code .hljs-addition {
    color: #ffb870 !important;
}
.prose pre code .hljs-deletion {
    color: #ff6b6b !important;
}
.prose pre code .hljs-operator,
.prose pre code .hljs-punctuation {
    color: #e09142 !important;
}

/* Remove backticks from code in prose */
.prose code::before,
.prose code::after {
    content: none !important;
}

.milkdown-theme-nord {
    --nord0: var(--background) !important;
    --nord4: var(--secondary) !important;
    --nord6: var(--secondary) !important;
    --nord10: var(--primary) !important; /* Headers usually use nord10 in this theme */
}

/* Prose headers override */
.prose :where(h1) {
    color: var(--header-color-1) !important;
    font-weight: bold !important;
    margin-bottom: var(--header-margin-bottom) !important;
}
.prose :where(h2) {
    color: var(--header-color-2) !important;
    font-weight: bold !important;
    margin-bottom: var(--header-margin-bottom) !important;
}
.prose :where(h3) {
    color: var(--header-color-3) !important;
    font-weight: bold !important;
    margin-bottom: var(--header-margin-bottom) !important;
}
.prose :where(h4) {
    color: var(--header-color-4) !important;
    font-weight: bold !important;
    margin-bottom: var(--header-margin-bottom) !important;
}
.prose :where(h5, h6) {
    color: var(--header-color-4) !important;
    font-weight: bold !important;
    margin-bottom: calc(var(--header-margin-bottom) * 0.25) !important;
}

/* Milkdown headers override */
.milkdown .editor :where(h1, h2, h3, h4) {
    margin-bottom: var(--header-margin-bottom) !important;
}

/* Prose text color */
.prose {
    color: var(--secondary) !important;
    font-size: var(--font-size-base) !important;
}
.prose h4 {
    font-size: calc(var(--font-size-base) + var(--font-size-delta)) !important;
}
.prose h3 {
    font-size: calc(var(--font-size-base) + 2 * var(--font-size-delta)) !important;
}
.prose h2 {
    font-size: calc(var(--font-size-base) + 3 * var(--font-size-delta)) !important;
}
.prose h1 {
    font-size: calc(var(--font-size-base) + 4 * var(--font-size-delta)) !important;
}
.prose strong {
    color: var(--primary) !important;
}

/* Blockquote styling */
.prose blockquote,
.milkdown .editor blockquote {
    border-left: 3px solid var(--primary) !important;
    padding-left: 2rem !important;
    margin-top: var(--block-margin) !important;
    margin-bottom: var(--block-margin) !important;
    margin-left: 1px !important;
    color: var(--secondary) !important;
    font-style: normal;
}

/* Horizontal Rule styling */
.prose hr,
.milkdown .editor hr {
    border: none !important;
    border-top: 1px solid var(--foreground) !important;
    margin-top: var(--header-margin-bottom) !important;
    margin-bottom: var(--header-margin-bottom) !important;
    margin-right: 5px;
}
.prose hr:first-child,
.milkdown .editor hr:first-child {
    margin-top: 10px !important;
}
.prose hr:last-child,
.milkdown .editor hr:last-child {
    margin-bottom: 6px !important;
}

 /* Image Styling */
.prose img,
.milkdown .editor img {
    border-radius: var(--radius-sm) !important;
    border: 2px solid color-mix(in srgb, var(--secondary) 40%, transparent);
    margin-top: var(--block-margin) !important;
    margin-bottom: var(--block-margin) !important;
}

/* Caption element — smaller text, inherits color so bold/italic formatting works */
.prose .caption,
.milkdown .editor .caption {
    font-size: calc(var(--font-size-base) * 0.85);
}

/* Caption paragraph adjacent to ANY element — collapse the neighbor's facing margin.
 * The caption <p> itself has no margin (from Tailwind reset), so we only need
 * to remove the margin on the adjacent element's side that faces the caption. */

/* Element directly BEFORE a caption paragraph → collapse its bottom margin */
.prose *:not(br):has(+ p:has(> .caption)),
.milkdown .editor *:not(br):has(+ p:has(> .caption)) {
    margin-bottom: 0 !important;
}

/* Element directly AFTER a caption paragraph → collapse its top margin */
.prose p:has(> .caption) + *:not(br),
.milkdown .editor p:has(> .caption) + *:not(br) {
    margin-top: 0 !important;
}

/* Section Scoping Logic */
.section-scope[data-level="1"] { --primary: var(--header-color-1) !important; --color-primary: var(--header-color-1) !important; }
.section-scope[data-level="2"] { --primary: var(--header-color-2) !important; --color-primary: var(--header-color-2) !important; }
.section-scope[data-level="3"] { --primary: var(--header-color-3) !important; --color-primary: var(--header-color-3) !important; }
.section-scope[data-level="4"] { --primary: var(--header-color-4) !important; --color-primary: var(--header-color-4) !important; }

/* Cell List Transition Group */
.cell-list-move {
  transition: transform 0.3s ease-in-out;
}

.cell-list-enter-active,
.cell-list-exit-active {
  transition: opacity 0.3s, transform 0.3s;
}

.cell-list-enter-from,
.cell-list-exit-to {
  opacity: 0;
  transform: translateX(20px);
}

/* Chart container styles - ensure consistent border-radius with UI components */
.pynote-plot,
.pynote-chart,
.pynote-timeseries {
    border-radius: var(--radius-sm) !important;
}

/* 
 * Chart text DEFAULT styling - high specificity but NO !important
 * This allows inline styles (from user props) to override these defaults
 */

/* Default font family for all chart text */
.pynote-plot svg text,
.pynote-chart svg text,
.pynote-timeseries canvas + * text,
.frappe-chart svg text {
    font-family: var(--font-mono);
}

/* Default tick/number size: 12px, secondary at 40% */
.pynote-plot svg text,
.frappe-chart svg .axis text,
.frappe-chart svg .chart-label {
    font-size: 12px;
    fill: color-mix(in srgb, var(--secondary) 40%, transparent);
}

/* Observable Plot axis labels (x-axis label, y-axis label text) 
 * These are the actual label text elements in the axis groups
 * xs font size (0.75rem), same color as title (70%), semi-bold
 */
.pynote-plot svg g[aria-label="x-axis"] > text:first-of-type,
.pynote-plot svg g[aria-label="y-axis"] > text:first-of-type,
.pynote-plot svg [aria-label*="axis label"] {
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    fill: color-mix(in srgb, var(--secondary) 70%, transparent) !important;
}

/* Frappe Charts axis labels */
.frappe-chart svg .y-axis-title,
.frappe-chart svg .x-axis-title {
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    fill: color-mix(in srgb, var(--secondary) 70%, transparent) !important;
}

/* Default title size: 15px, semi-bold, title color */
.pynote-plot svg text[aria-label="title"],
.pynote-plot svg [aria-label="title"] text,
.frappe-chart svg .title {
    font-size: 15px !important;
    font-weight: 600 !important;
    fill: color-mix(in srgb, var(--secondary) 70%, transparent) !important;
}

/* Frappe Charts grid lines - match Observable Plot dim grid (10% accent) */
.frappe-chart svg .chart-strokes line,
.frappe-chart svg .y-axis line.dashed,
.frappe-chart svg line.dashed {
    stroke: color-mix(in srgb, var(--accent) 10%, transparent) !important;
}

/* uPlot axis styling defaults */
.pynote-timeseries .u-axis {
    font-family: var(--font-mono);
    font-size: 12px;
    color: color-mix(in srgb, var(--secondary) 40%, transparent);
}

.pynote-timeseries .u-label {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 600;
    color: color-mix(in srgb, var(--secondary) 70%, transparent);
}

/* Remove bottom margin from last header to prevent double spacing */
.prose > :where(h1, h2, h3, h4):last-child,
.prose > .section-scope:last-child > :where(h1, h2, h3, h4):last-child,
.milkdown .editor > :where(h1, h2, h3, h4):last-child {
    margin-bottom: 0 !important;
}